# Mid-mortem: teams idle status fix + session state

- **id**: p-0777
- **type**: task
- **status**: in_progress
- **priority**: 3
- **tags**: mid-mortem, compaction
- **created**: 2026-02-25

---
status: closed

## What was being worked on

User reported that the teams widget shows `idle` for all workers even when they're clearly active (running, posting progress notes). The screenshot showed all workers with green `running` dots and progress messages, but the sub-line said `idle` for every one.

## Decisions made

- **Three-way state instead of binary**: Changed `formatRuntimeSummary` in `extensions/teams/activity.ts` from a binary `hasActiveChildProcess ? "busy" : "idle"` to three states:
  - **busy** — has active child processes (running bash, tools, etc.)
  - **thinking** — no child processes but `lastOutputAt` is within 2 minutes (agent is streaming/waiting for LLM API)
  - **idle** — no child processes AND no output for >2 minutes (genuinely stale)
- **Threshold**: `THINKING_THRESHOLD_MS = 120_000` (2 minutes) — chosen because agents can sit for a while on long LLM completions. This is not a YAGNI cap, it matches real observed API wait times.
- **Rationale**: When an agent is waiting for an LLM API response, there are zero child processes — just the pi process on an HTTP call. "idle" is factually wrong and misleads coordinators/other agents into thinking nobody's working.

## Progress

- **Done**: Fix committed to `main` as `d1442ef` — `fix(teams): show 'thinking' instead of 'idle' for active workers`
- **Files changed**: `extensions/teams/activity.ts` (logic), `tests/teams/activity.test.ts` (3 new test cases)
- **Tests**: All 10 activity tests pass. All other teams tests pass. 2 pre-existing failures in `polling.test.ts` and `state.test.ts` (stale files referencing removed modules — not related).

## Open threads

- The worktree had many other uncommitted changes (code-mode, totalrecall, worker lifecycle, spawner, etc.) — only the activity fix was staged and committed. Those other changes are still unstaged in the working tree.
- The pre-existing test failures in `tests/teams/polling.test.ts` and `tests/teams/state.test.ts` should be cleaned up — they reference modules that no longer exist.
- A `git index.lock` file had to be manually removed during the commit — another git process may have been running or crashed earlier.

## Gotchas & learnings

- **git index.lock**: Hit `Unable to create index.lock` — resolved with `rm .git/index.lock`. Sign of concurrent git operations or a previously crashed git process.
- **The "idle" label was actively harmful**: It wasn't just cosmetic — agents reading the `list` action output would see "idle" and assume workers weren't progressing, potentially leading to incorrect coordination decisions.
- **`lastOutputAt` is the key signal**: Session file mtime / last output timestamp is the most reliable indicator of agent activity, not child process presence. Most agent time is spent on LLM API calls with zero child processes.
