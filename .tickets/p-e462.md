---
id: p-e462
status: closed
deps: []
links: []
created: 2026-02-14T07:29:37Z
type: bug
priority: 1
assignee: Alexander Mangel
tags: [teams, bug]
---
# Teams workers ignore useWorktree:false and race condition causes post-completion events

Two bugs in teams extension: (1) File watcher continues emitting comment events after worker process exits due to race between async handleTicketChange and handleWorkerExit. (2) When useWorktree:false, workers should share caller's cwd but cleanup/lifecycle still behaves as if worktrees exist.



## Goal
Fix race condition where file watcher fires after process exit, causing post-completion events. Ensure useWorktree:false workers cleanly share the caller's working directory.

## Acceptance Criteria
- [ ] File watcher is closed BEFORE handling worker exit logic
- [ ] No comment events emitted after completed/failed event
- [ ] useWorktree:false workers run in ctx.cwd with no worktree cleanup

## Verification
- [ ] Inspect code: unwatchWorker called before any async work in handleWorkerExit
- [ ] Inspect code: handleTicketChange bails immediately if worker status is terminal

## Worktree
- .

## Notes

**2026-02-14T07:45:23Z**

Investigation: The useWorktree:false code path is correct â€” no worktree is created, no worktree cleanup happens. The likely cause is the LLM omitted useWorktree from the tool call JSON (it's Optional with default:true), so params.useWorktree was undefined and the ?? true fallback kicked in. Race condition fix (unwatchWorker before status change) is the only real code bug found.
