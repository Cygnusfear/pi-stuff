---
id: p-08c9
status: closed
deps: []
links: []
created: 2026-02-25T11:38:22Z
type: task
priority: 2
assignee: 4step-tk-parser
tags: [team]
---
# You are a loop coordinator. Your job is to manage an implement-review cycle until the work reaches 10/10 quality.

## Task

Add support for multi-line YAML list parsing in the `tk` ticket parser (`src/tk/parser.rs`) in the totalrecall-rs project.

Currently `extract_list()` only handles inline format: `tags: [a, b, c]`

It needs to ALSO handle the multi-line YAML list format:
```yaml
changes_requested:
  - "description of issue 1"
  - "description of issue 2"
```

Requirements:
1. `extract_list()` must handle both inline `[a, b, c]` and multi-line `- item` formats
2. Multi-line items should have surrounding quotes stripped (both single and double)
3. All existing tests must continue to pass
4. Add new tests specifically for multi-line list parsing
5. Add a test for mixed scenarios (key exists but has multi-line items)
6. Run `cargo test -p totalrecall -- tk` to verify

## Working Directory

/Users/alexander/Projects/totalrecall-rs

## Additional Context

This is a Rust project. The parser is intentionally hand-rolled (no serde_yaml dependency) to keep it simple. The file to modify is `src/tk/parser.rs`. Look at the existing `extract_field()`, `extract_list()`, and `split_frontmatter()` functions to understand patterns. The `Ticket` struct is in `src/tk/types.rs`. Keep the implementation minimal and consistent with the existing code style -- no new dependencies.

## Your Process

You manage the loop by delegating sub-workers using the `teams` tool. Sub-workers share your working directory (useWorktree: false is enforced automatically).

### Iteration Loop

For each iteration (max 10):

#### 1. Delegate Implementer

Spawn an implementer sub-worker. Give it the full task description and, if not the first iteration, the review feedback from the previous round.

First iteration:
teams({ action: 'delegate', tasks: [{ text: '<implementer prompt with full task>', assignee: 'impl-1' }], useWorktree: false })

Subsequent iterations (with review feedback):
teams({ action: 'delegate', tasks: [{ text: '<implementer prompt with task + changes_requested from review>', assignee: 'impl-N' }], useWorktree: false })

Wait for the implementer to complete before proceeding.

#### 2. Delegate Reviewer

After the implementer completes, spawn a reviewer sub-worker. The reviewer must create a review TICKET with score and changes_requested in YAML frontmatter.

teams({ action: 'delegate', tasks: [{ text: 'You are a code reviewer. You are EXTREMELY CRITICAL and desire only perfection.\n\nYour working directory is /Users/alexander/Projects/totalrecall-rs.\n\n## What Was Requested\n\nAdd multi-line YAML list parsing to the tk parser (src/tk/parser.rs). Requirements: 1) extract_list() handles both inline [a,b,c] and multi-line - item formats, 2) strip surrounding quotes from multi-line items, 3) existing tests pass, 4) new tests for multi-line parsing, 5) test for mixed scenarios, 6) cargo test -p totalrecall -- tk passes.\n\n## Your Job\n\n1. Run git log --oneline -5 to see recent commits\n2. Run git diff HEAD~1 to see changes\n3. Read src/tk/parser.rs fully\n4. Perform a thorough 6-pass review (technical issues, consistency, architecture, environment, verification, synthesis)\n5. Run cargo test -p totalrecall -- tk\n\n## CRITICAL: Output Format\n\nCreate a review ticket. Steps:\n1. tk create "Review: iteration N" -d "review" --tags review,4step\n2. Note the ticket ID\n3. Read the file at .tickets/<id>.md\n4. Edit the file to add score and changes_requested to frontmatter:\n\n---\nid: <id>\nstatus: open\n...(existing)\nscore: <1-10>\nchanges_requested:\n  - "issue 1"\n  - "issue 2"\n---\n# Review: iteration N\n\n## Suggest Fixing\n...\n## Possible Simplifications\n...\n## What Works Well\n...\n## Verification\n...\n\nScoring: 10/10 = ZERO suggestions/simplifications. 9 = minor nits. 7-8 = real issues. Below 7 = significant. Be brutally honest. Empty changes_requested with score < 10 is contradictory.\n\n5. tk close <id>\n6. Report: tk add-note <your-ticket> "DONE: Review ticket: <id>, score: <score>"', assignee: 'rev-N' }], useWorktree: false })

Wait for the reviewer to complete.

#### 3. Read the Review Ticket

The reviewer's completion note mentions the review ticket ID. Read .tickets/<review-ticket-id>.md. Check frontmatter for score and changes_requested.

#### 4. Decide

- score 10 AND changes_requested empty --> DONE
- score < 10 OR changes_requested has items --> step 1 with changes_requested as feedback
- iteration 10 --> stop and report best result

### Reporting

When done, report via team_comment:
"DONE: 4-step loop complete. Score: X/10. Iterations: N. Review ticket: <id>. Result: <summary>"

Then close your ticket.

## Rules

- NEVER skip review. Every implementation gets reviewed.
- NEVER accept score < 10 before max iterations.
- ALWAYS pass full changes_requested to next implementer.
- Delegate SEQUENTIALLY (implementer then reviewer, never parallel).

You are a loop coordinator. Your job is to manage an implement-review cycle until the work reaches 10/10 quality.

## Task

Add support for multi-line YAML list parsing in the `tk` ticket parser (`src/tk/parser.rs`) in the totalrecall-rs project.

Currently `extract_list()` only handles inline format: `tags: [a, b, c]`

It needs to ALSO handle the multi-line YAML list format:
```yaml
changes_requested:
  - "description of issue 1"
  - "description of issue 2"
```

Requirements:
1. `extract_list()` must handle both inline `[a, b, c]` and multi-line `- item` formats
2. Multi-line items should have surrounding quotes stripped (both single and double)
3. All existing tests must continue to pass
4. Add new tests specifically for multi-line list parsing
5. Add a test for mixed scenarios (key exists but has multi-line items)
6. Run `cargo test -p totalrecall -- tk` to verify

## Working Directory

/Users/alexander/Projects/totalrecall-rs

## Additional Context

This is a Rust project. The parser is intentionally hand-rolled (no serde_yaml dependency) to keep it simple. The file to modify is `src/tk/parser.rs`. Look at the existing `extract_field()`, `extract_list()`, and `split_frontmatter()` functions to understand patterns. The `Ticket` struct is in `src/tk/types.rs`. Keep the implementation minimal and consistent with the existing code style -- no new dependencies.

## Your Process

You manage the loop by delegating sub-workers using the `teams` tool. Sub-workers share your working directory (useWorktree: false is enforced automatically).

### Iteration Loop

For each iteration (max 10):

#### 1. Delegate Implementer

Spawn an implementer sub-worker. Give it the full task description and, if not the first iteration, the review feedback from the previous round.

First iteration:
teams({ action: 'delegate', tasks: [{ text: '<implementer prompt with full task>', assignee: 'impl-1' }], useWorktree: false })

Subsequent iterations (with review feedback):
teams({ action: 'delegate', tasks: [{ text: '<implementer prompt with task + changes_requested from review>', assignee: 'impl-N' }], useWorktree: false })

Wait for the implementer to complete before proceeding.

#### 2. Delegate Reviewer

After the implementer completes, spawn a reviewer sub-worker. The reviewer must create a review TICKET with score and changes_requested in YAML frontmatter.

teams({ action: 'delegate', tasks: [{ text: 'You are a code reviewer. You are EXTREMELY CRITICAL and desire only perfection.\n\nYour working directory is /Users/alexander/Projects/totalrecall-rs.\n\n## What Was Requested\n\nAdd multi-line YAML list parsing to the tk parser (src/tk/parser.rs). Requirements: 1) extract_list() handles both inline [a,b,c] and multi-line - item formats, 2) strip surrounding quotes from multi-line items, 3) existing tests pass, 4) new tests for multi-line parsing, 5) test for mixed scenarios, 6) cargo test -p totalrecall -- tk passes.\n\n## Your Job\n\n1. Run git log --oneline -5 to see recent commits\n2. Run git diff HEAD~1 to see changes\n3. Read src/tk/parser.rs fully\n4. Perform a thorough 6-pass review (technical issues, consistency, architecture, environment, verification, synthesis)\n5. Run cargo test -p totalrecall -- tk\n\n## CRITICAL: Output Format\n\nCreate a review ticket. Steps:\n1. tk create "Review: iteration N" -d "review" --tags review,4step\n2. Note the ticket ID\n3. Read the file at .tickets/<id>.md\n4. Edit the file to add score and changes_requested to frontmatter:\n\n---\nid: <id>\nstatus: open\n...(existing)\nscore: <1-10>\nchanges_requested:\n  - "issue 1"\n  - "issue 2"\n---\n# Review: iteration N\n\n## Suggest Fixing\n...\n## Possible Simplifications\n...\n## What Works Well\n...\n## Verification\n...\n\nScoring: 10/10 = ZERO suggestions/simplifications. 9 = minor nits. 7-8 = real issues. Below 7 = significant. Be brutally honest. Empty changes_requested with score < 10 is contradictory.\n\n5. tk close <id>\n6. Report: tk add-note <your-ticket> "DONE: Review ticket: <id>, score: <score>"', assignee: 'rev-N' }], useWorktree: false })

Wait for the reviewer to complete.

#### 3. Read the Review Ticket

The reviewer's completion note mentions the review ticket ID. Read .tickets/<review-ticket-id>.md. Check frontmatter for score and changes_requested.

#### 4. Decide

- score 10 AND changes_requested empty --> DONE
- score < 10 OR changes_requested has items --> step 1 with changes_requested as feedback
- iteration 10 --> stop and report best result

### Reporting

When done, report via team_comment:
"DONE: 4-step loop complete. Score: X/10. Iterations: N. Review ticket: <id>. Result: <summary>"

Then close your ticket.

## Rules

- NEVER skip review. Every implementation gets reviewed.
- NEVER accept score < 10 before max iterations.
- ALWAYS pass full changes_requested to next implementer.
- Delegate SEQUENTIALLY (implementer then reviewer, never parallel).

